
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Waqas & Safiyya Moments</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’ž</text></svg>">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            serif: ['Playfair Display', 'serif'],
            display: ['SF Pro Display', 'Inter', 'sans-serif'],
          },
          colors: {
            rose: {
              50: '#fff1f2',
              100: '#ffe4e6',
              200: '#fecdd3',
              300: '#fda4af',
              400: '#fb7185',
              500: '#f43f5e',
            },
          }
        }
      }
    }
  </script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  
  <!-- React & Framer Motion from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

  <style>
    body {
      background-color: #fdf2f8;
      overscroll-behavior-y: none;
      margin: 0;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }
    
    .glass-panel {
      background: rgba(255, 255, 255, 0.45);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }
    
    /* Specific Lock Screen Styles */
    .lock-input::placeholder {
      color: #cbd5e1;
      font-weight: 400;
      letter-spacing: normal;
    }

    /* Mobile Background Fallback (Lightweight) */
    .mobile-bg {
      background: radial-gradient(circle at 50% 30%, #fff1f2 0%, #fff5f7 100%);
    }
    
    /* Optimized Card Layering */
    .card-layer {
      /* Replaced transform hack with just backface visibility */
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      /* Ensure touch events work */
      touch-action: pan-y; 
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, memo } = React;
    
    // Safety check for Framer Motion
    const MotionLib = window.Motion || window.framerMotion;
    const { motion, AnimatePresence, useMotionValue, useTransform } = MotionLib || { 
      motion: { div: 'div' }, 
      AnimatePresence: ({children}) => children,
      useMotionValue: () => ({ get: () => 0, set: () => {}, onChange: () => {} }),
      useTransform: () => 0
    };

    // --- ICONS ---
    const HeartIcon = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
    );
    const ClockIcon = ({ size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    );
    const HourglassIcon = ({ size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/></svg>
    );
    const HistoryIcon = ({ size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></svg>
    );
    const RotateCwIcon = ({ size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 12"/><path d="M21 3v9h-9"/></svg>
    );
    const ChevronLeftIcon = ({ size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
    );
    const ChevronRightIcon = ({ size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    );
    const LockIcon = ({ size, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="5" y="11" width="14" height="10" rx="2" ry="2" />
        <path d="M8 11V7a4 4 0 0 1 8 0v4" />
      </svg>
    );
    const LockOpenIcon = ({ size, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="5" y="11" width="14" height="10" rx="2" ry="2" />
        <path d="M8 11V7a4 4 0 0 1 8 0" />
      </svg>
    );

    // --- DATA & CONSTANTS ---
    const BASE_START_DATE = new Date(2025, 7, 1, 0, 0, 0); 
    const LOCK_CODE = "2306";

    const STATIC_EVENTS = [
      { id: "new-year", title: "New Year", month: 1, day: 1, hour: 0, minute: 0, icon: "ðŸŽ†", description: "Another year together." },
      { id: "new-beginning", title: "The New Beginning", month: 1, day: 24, hour: 12, minute: 30, icon: "âœ¨", description: "Start of a beautiful chapter." },
      { id: "safiyya-bday", title: "Safiyya Birthday", month: 2, day: 17, hour: 22, minute: 30, icon: "ðŸŽ‰", description: "Celebrating my love." },
      { id: "waqas-bday", title: "Waqas Birthday", month: 6, day: 23, hour: 17, minute: 30, icon: "ðŸŽ‚", description: "Celebrating you." },
      { id: "your-presence", title: "Your Presence", month: 8, day: 8, hour: 14, minute: 0, icon: "â¤ï¸", description: "The day everything felt right." },
      { id: "first-glimpse", title: "The First Glimpse", month: 8, day: 11, hour: 19, minute: 55, icon: "ðŸ‘€", description: "Seeing you for the first time." },
      { id: "confirmation", title: "The Confirmation", month: 8, day: 14, hour: 20, minute: 30, icon: "âœ…", description: "Making it official." },
      { id: "unfiltered", title: "The Unfiltered", month: 8, day: 23, hour: 22, minute: 30, icon: "ðŸ“¸", description: "Real, raw, and beautiful." },
      { id: "first-salam", title: "The First Salam", month: 8, day: 25, hour: 13, minute: 0, icon: "ðŸ¤", description: "Peace be upon you." },
      { id: "engagement", title: "The Engagement", month: 9, day: 21, hour: 14, minute: 0, icon: "ðŸ’", description: "A promise for forever." },
      { id: "first-words", title: "The First Words", month: 10, day: 10, hour: 22, minute: 40, icon: "ðŸ—£ï¸", description: "When silence turned into a story." }
    ];

    const ISLAMIC_CONFIG = [
      { id: "islamic-new-year", title: "Islamic New Year", hijriMonth: 1, hijriDay: 1, icon: "ðŸŒ™", description: "1st Muharram - A new spiritual year." },
      { id: "ramadan", title: "1st Ramadan", hijriMonth: 9, hijriDay: 1, icon: "ðŸ“¿", description: "The holy month of fasting begins." },
      { id: "laylatul-qadr", title: "Laylatul Qadr", hijriMonth: 9, hijriDay: 20, icon: "âœ¨", description: "20th Ramadan - The Night of Decree." },
      { id: "eid-fitr", title: "Eid ul-Fitr", hijriMonth: 10, hijriDay: 1, icon: "ðŸ•Œ", description: "Festival of breaking the fast." },
      { id: "eid-adha", title: "Eid ul-Adha", hijriMonth: 12, hijriDay: 10, icon: "ðŸ‘", description: "Festival of sacrifice." },
      { id: "shab-barat", title: "Shab-e-Barat", hijriMonth: 8, hijriDay: 15, icon: "ðŸ¤²", description: "15th Shaban - The night of forgiveness." }
    ];

    const FALLBACK_ISLAMIC_DATES = {
      "islamic-new-year": "2025-06-26",
      "ramadan": "2025-03-01",
      "laylatul-qadr": "2025-03-20",
      "eid-fitr": "2025-03-31",
      "eid-adha": "2025-06-07",
      "shab-barat": "2025-02-14"
    };

    // --- SERVICES ---
    const pad2 = (n) => String(n).padStart(2, "0");

    const getSuffix = (n) => {
      if (n % 10 === 1 && n % 100 !== 11) return "st";
      if (n % 10 === 2 && n % 100 !== 12) return "nd";
      if (n % 10 === 3 && n % 100 !== 13) return "rd";
      return "th";
    };

    const getDaysDifference = (a, b) => {
      if (!a || !b) return 0;
      const oneDay = 1000 * 60 * 60 * 24;
      const diffInTime = Math.abs(b.getTime() - a.getTime());
      return Math.floor(diffInTime / oneDay);
    };

    const getEventWindow = (ev, now) => {
      if (!ev) return { start: now, end: now };

      if (ev.dynamicDate) {
        const center = new Date(ev.dynamicDate);
        const start = new Date(center);
        start.setDate(center.getDate() - 1);
        start.setHours(0, 0, 0, 0);

        const end = new Date(center);
        end.setDate(center.getDate() + 1);
        end.setHours(23, 59, 59, 999);
        return { start, end };
      }

      const year = now.getFullYear();
      let start = new Date(year, ev.month - 1, ev.day, ev.hour || 0, ev.minute || 0, 0);
      let end = new Date(year, ev.month - 1, ev.day, 23, 59, 59, 999);

      if (end < now) {
        start.setFullYear(year + 1);
        end.setFullYear(year + 1);
      }

      return { start, end };
    };

    const getNextOccurrence = (ev, now) => {
      if (!ev) return now;
      if (ev.dynamicDate) return new Date(ev.dynamicDate);
      const w = getEventWindow(ev, now);
      return w.start;
    };

    const getLastOccurrence = (ev, from) => {
      if (!ev) return from;
      if (ev.dynamicDate) {
         const d = new Date(ev.dynamicDate);
         d.setDate(d.getDate() - 354); 
         return d;
      }
      let y = from.getFullYear();
      let d = new Date(y, ev.month - 1, ev.day, ev.hour || 0, ev.minute || 0, 0);
      if (d > from) {
        y--;
        d = new Date(y, ev.month - 1, ev.day, ev.hour || 0, ev.minute || 0, 0);
      }
      return d;
    };

    const countOccurrences = (ev, base, now) => {
      if (!ev) return 0;
      let c = 0;
      let y = base.getFullYear();
      let safety = 0;
      if (ev.dynamicDate) {
         return Math.max(0, now.getFullYear() - base.getFullYear());
      }
      while (safety < 1000) {
        const d = new Date(y, ev.month - 1, ev.day, ev.hour || 0, ev.minute || 0, 0);
        if (d > now) break;
        if (d >= base) c++;
        y++;
        safety++;
      }
      return c;
    };

    const calculateTimeParts = (target, now) => {
      if (!target || !now) return { months: 0, days: 0, hours: 0, minutes: 0, seconds: 0 };
      let diff = target.getTime() - now.getTime();
      if (diff < 0) diff = 0;

      const s = Math.floor(diff / 1000);
      const secMon = 30 * 24 * 60 * 60; 
      const secDay = 24 * 60 * 60;

      const months = Math.floor(s / secMon);
      let rem = s - months * secMon;
      const days = Math.floor(rem / secDay);
      rem -= days * secDay;
      const hours = Math.floor(rem/3600);
      rem -= hours * 3600;
      const minutes = Math.floor(rem/60);
      const seconds = rem - minutes * 60;

      return { months, days, hours, minutes, seconds };
    };

    const getStatus = (events, now) => {
      for (const ev of events) {
        const w = getEventWindow(ev, now);
        if (now >= w.start && now <= w.end) {
          return { activeEvent: ev, isLive: true, targetDate: w.end };
        }
      }

      let bestEvent = null;
      let bestStart = null;
      
      for (const ev of events) {
        const nextDate = getNextOccurrence(ev, now);
        if (nextDate > now) {
          if (!bestStart || nextDate < bestStart) {
            bestStart = nextDate;
            bestEvent = ev;
          }
        }
      }
      return { activeEvent: bestEvent, isLive: false, targetDate: bestStart };
    };

    const fetchIslamicEvents = async () => {
      const today = new Date();
      let currentHijriYear = 1446;

      try {
        const gToHRes = await fetch(`https://api.aladhan.com/v1/gToH?date=${pad2(today.getDate())}-${pad2(today.getMonth() + 1)}-${today.getFullYear()}`);
        if (gToHRes.ok) {
          const gToHData = await gToHRes.json();
          currentHijriYear = parseInt(gToHData.data.hijri.year);
        }
      } catch (e) {
        // Silent fail
      }

      const promises = ISLAMIC_CONFIG.map(async (config) => {
        try {
          const targetHijriDate = `${pad2(config.hijriDay)}-${pad2(config.hijriMonth)}-${currentHijriYear}`;
          let res = await fetch(`https://api.aladhan.com/v1/hToG?date=${targetHijriDate}`);
          
          if (!res.ok) throw new Error(`API error for ${config.id}`);
          let data = await res.json();
          
          const [dStr, mStr, yStr] = data.data.gregorian.date.split('-');
          let gregDate = new Date(parseInt(yStr), parseInt(mStr) - 1, parseInt(dStr));
          
          const eventEndBuffer = new Date(gregDate);
          eventEndBuffer.setDate(eventEndBuffer.getDate() + 1);
          eventEndBuffer.setHours(23, 59, 59);

          // If date has passed for this Hijri year, fetch next year
          if (eventEndBuffer < today) {
             const nextHijriDate = `${pad2(config.hijriDay)}-${pad2(config.hijriMonth)}-${currentHijriYear + 1}`;
             res = await fetch(`https://api.aladhan.com/v1/hToG?date=${nextHijriDate}`);
             if (res.ok) {
                data = await res.json();
                const [dNext, mNext, yNext] = data.data.gregorian.date.split('-');
                gregDate = new Date(parseInt(yNext), parseInt(mNext) - 1, parseInt(dNext));
             }
          }
          
          gregDate.setHours(9, 0, 0, 0);

          return {
            ...config,
            dynamicDate: gregDate,
            hour: 9, 
            minute: 0
          };

        } catch (e) {
          const fallbackStr = FALLBACK_ISLAMIC_DATES[config.id];
          if (!fallbackStr) return null;
          let d = new Date(fallbackStr);
          d.setHours(9,0,0,0);
          
          const now = new Date();
          if (d < now) {
             d.setDate(d.getDate() + 354);
          }

          return { ...config, dynamicDate: d, hour: 9, minute: 0 };
        }
      });

      const results = await Promise.all(promises);
      return results.filter(e => e !== null);
    };

    // --- COMPONENTS ---
    // Pure Component for Background to avoid unnecessary re-renders
    const Background = memo(() => {
      return (
        <div className="fixed inset-0 w-full h-full -z-10 mobile-bg">
          <div className="hidden sm:block absolute inset-0 overflow-hidden">
            <motion.div 
              animate={{ y: [0, -40, 0], x: [0, 20, 0], scale: [1, 1.1, 1] }}
              transition={{ duration: 15, repeat: Infinity, ease: "easeInOut" }}
              className="absolute -top-20 -left-20 w-96 h-96 bg-rose-100 rounded-full mix-blend-multiply filter blur-[80px] opacity-40"
            />
            <motion.div 
              animate={{ y: [0, 50, 0], x: [0, -30, 0], scale: [1, 1.2, 1] }}
              transition={{ duration: 18, repeat: Infinity, ease: "easeInOut", delay: 1 }}
              className="absolute -bottom-32 -right-32 w-[30rem] h-[30rem] bg-pink-100 rounded-full mix-blend-multiply filter blur-[80px] opacity-50"
            />
          </div>
        </div>
      );
    });

    const LockScreen = ({ onUnlock }) => {
      const [pin, setPin] = useState("");
      const [errorCount, setErrorCount] = useState(0);
      const [isUnlocking, setIsUnlocking] = useState(false);
      const [shake, setShake] = useState(false);
      const inputRef = useRef(null);

      const ERRORS = [
        "Hmmâ€¦ that wasnâ€™t the right code.", 
        "Hmmâ€¦ not quite right.",            
        "I know you know this ðŸ˜˜",           
        "DDMM â¤ï¸ (No slashes)",             
        "Iâ€™ll waitâ€¦ take your time ðŸ¤"       
      ];

      const handleUnlock = () => {
        if (pin === LOCK_CODE) {
          setIsUnlocking(true);
          setTimeout(() => {
            onUnlock();
          }, 1800); 
        } else {
          setErrorCount(prev => prev + 1);
          setPin("");
          setShake(true);
          setTimeout(() => setShake(false), 500);
          inputRef.current?.focus();
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter') handleUnlock();
      };

      const errorMessage = errorCount > 0 ? ERRORS[Math.min(errorCount - 1, ERRORS.length - 1)] : "";

      return (
        <motion.div 
          className="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 text-center"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.8 }}
        >
          <motion.div 
             animate={shake ? { x: [0, -10, 10, -10, 10, 0] } : {}}
             transition={{ duration: 0.4 }}
             className="w-full max-w-sm flex flex-col items-center relative z-20"
          >
            <div className={`mb-8 transition-all duration-700 ${isUnlocking ? 'text-emerald-400 scale-110' : 'text-rose-200'}`}>
              {isUnlocking ? <LockOpenIcon size={56} className="drop-shadow-sm" /> : <LockIcon size={56} className="drop-shadow-sm" />}
            </div>

            <h1 className="font-serif text-5xl text-slate-800 leading-[1.1] mb-6 tracking-tight">
              Every second of us<br/>is preciousâ€¦<br/>and protected.
            </h1>
            
            <p className="text-slate-500 font-medium text-sm mb-10 px-4 leading-relaxed">
              Type your 4-digit birth code to unlock our countdown.
            </p>

            {!isUnlocking ? (
              <>
                <div className="relative w-full max-w-[280px] mb-8">
                  <input
                    ref={inputRef}
                    type="tel"
                    inputMode="numeric"
                    maxLength="4"
                    value={pin}
                    onChange={(e) => setPin(e.target.value)}
                    onKeyDown={handleKeyDown}
                    placeholder="Enter birth date code"
                    className={`
                      lock-input w-full px-6 py-4 rounded-full bg-white border border-rose-100/50 
                      text-center text-xl font-bold tracking-[0.4em] text-slate-700 shadow-[0_4px_20px_rgba(251,113,133,0.08)]
                      focus:outline-none focus:ring-2 focus:ring-rose-200 transition-all placeholder:tracking-normal
                      ${shake ? 'border-red-300 ring-2 ring-red-100' : ''}
                    `}
                  />
                </div>

                <div className="h-16 mb-6 flex flex-col items-center justify-center w-full">
                  <AnimatePresence mode="wait">
                    {errorMessage ? (
                      <motion.div 
                        key="error"
                        initial={{ opacity: 0, y: 5 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -5 }}
                        className="text-center"
                      >
                        <p className="text-red-400 font-medium text-sm">{errorMessage}</p>
                        <p className="text-[10px] text-rose-300 mt-1">The clock only opens for the girl who knows.</p>
                      </motion.div>
                    ) : (
                       <motion.div key="spacer" className="h-full"></motion.div>
                    )}
                  </AnimatePresence>
                </div>

                <button
                  onClick={handleUnlock}
                  className="w-full max-w-[280px] py-4 rounded-full bg-[#fca5a5] hover:bg-[#fb7185] text-white font-semibold shadow-lg shadow-rose-200/50 active:scale-95 transition-all duration-300"
                >
                  Continue to Our Time
                </button>
              </>
            ) : (
              <motion.div 
                initial={{ opacity: 0 }} 
                animate={{ opacity: 1 }}
                transition={{ delay: 0.2 }}
                className="mt-8 text-center"
              >
                <p className="text-xl font-serif text-slate-700">Welcome back, Safiyya.</p>
                <p className="text-sm text-rose-400 mt-2 font-medium">Time has been waiting for youâ€¦ ðŸ’ž</p>
              </motion.div>
            )}
          </motion.div>
        </motion.div>
      );
    };

    const TimeTile = memo(({ value, label }) => (
      <div className="flex flex-col items-center justify-center p-3 sm:p-4 rounded-2xl glass-panel shadow-sm border border-white/50 min-w-[65px] flex-1">
        <span className="text-2xl sm:text-3xl font-display font-semibold text-gray-800 tracking-tight">
          {pad2(value)}
        </span>
        <span className="text-[10px] sm:text-xs uppercase tracking-widest text-gray-500 font-medium mt-1">
          {label}
        </span>
      </div>
    ));

    const CountdownGrid = memo(({ parts, isLive }) => {
      const displayParts = isLive 
        ? { months: 0, days: 0, hours: 0, minutes: 0, seconds: 0 }
        : parts;

      return (
        <div className="flex gap-2 w-full max-w-md mx-auto mt-6 px-1">
          <TimeTile value={displayParts.months} label="Mos" />
          <TimeTile value={displayParts.days} label="Days" />
          <TimeTile value={displayParts.hours} label="Hrs" />
          <TimeTile value={displayParts.minutes} label="Min" />
          <TimeTile value={displayParts.seconds} label="Sec" />
        </div>
      );
    });

    // Memoized Card Component to prevent internal re-renders
    const TimelineCard = memo(({ event, isActive }) => {
      if (!event) return null;
      
      const now = new Date();
      // NOTE: We calculate these ONCE per render. 
      // Since TimelineCard is memoized, it won't re-render every second unless `isActive` or `event` changes.
      // This is crucial for fixing the "flickering" issue.
      const nextDate = getNextOccurrence(event, now);
      const lastDate = getLastOccurrence(event, now);
      const daysUntil = getDaysDifference(now, nextDate);
      const daysPassed = getDaysDifference(lastDate, now);
      const occurrences = countOccurrences(event, BASE_START_DATE, now);

      let dateDisplay = "";
      if (event.dynamicDate && !isNaN(new Date(event.dynamicDate).getTime())) {
         const d = new Date(event.dynamicDate);
         const start = new Date(d); start.setDate(d.getDate() - 1);
         const end = new Date(d); end.setDate(d.getDate() + 1);
         const opts = { month: 'short', day: 'numeric' };
         dateDisplay = `Expected: ${start.toLocaleDateString('en-US', opts)} - ${end.toLocaleDateString('en-US', opts)}`;
      } else if (nextDate && !isNaN(nextDate.getTime())) {
         dateDisplay = nextDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      } else {
        dateDisplay = "Loading...";
      }

      // Styles: Solid opaque background for mobile to fix rendering bug
      const cardStyle = isActive 
        ? 'bg-[#ffffff] sm:bg-white/65 sm:backdrop-blur-xl shadow-lg sm:shadow-[0_20px_50px_rgba(8,112,184,0.12)] border-rose-100 sm:border-white/60' 
        : 'bg-[#ffffff] sm:bg-white/60 border-slate-100 sm:border-white/20 opacity-100 sm:opacity-80 scale-100 sm:scale-95';

      return (
        <div 
          className={`
            card-layer relative w-full max-w-[340px] h-[480px] rounded-[40px] p-6 flex flex-col items-center text-center
            border transition-all duration-300
            ${cardStyle}
          `}
        >
          <div className={`
            w-20 h-20 rounded-3xl flex items-center justify-center text-4xl mb-6 shadow-md sm:shadow-lg sm:shadow-rose-500/10
            transition-transform duration-300
            ${isActive ? 'bg-gradient-to-br from-rose-50 to-rose-100 sm:from-white sm:to-rose-50 scale-100' : 'bg-slate-50 sm:bg-white/50 scale-100 sm:scale-90 sm:grayscale'}
          `}>
            {event.icon}
          </div>

          <div className="space-y-2 mb-8 w-full">
            <h3 className="font-serif text-3xl text-slate-900 leading-tight">
              {event.title}
            </h3>
            <p className="text-slate-500 font-medium text-sm sm:text-base">
               {dateDisplay}
            </p>
          </div>

          <div className="w-full grid grid-cols-2 gap-3 mt-auto">
            <div className="col-span-2 bg-rose-50 rounded-2xl p-4 border border-rose-100">
               <div className="flex items-center justify-center gap-2 text-rose-400 mb-1">
                 <HourglassIcon size={14} />
                 <span className="text-[10px] uppercase tracking-widest font-bold">Countdown</span>
               </div>
               <div className="text-2xl font-bold text-slate-800">
                 {daysUntil} <span className="text-sm font-medium text-slate-500">Days to go</span>
               </div>
            </div>

            <div className="bg-slate-50 sm:bg-white/40 rounded-2xl p-4 border border-slate-100 sm:border-white/50 flex flex-col justify-between">
               <div className="flex items-center justify-center gap-1.5 text-slate-400 mb-2">
                 <HistoryIcon size={14} />
                 <span className="text-[10px] uppercase tracking-wider font-semibold">Passed</span>
               </div>
               <div className="text-lg font-bold text-slate-700 leading-none">
                 {daysPassed}
                 <span className="block text-[10px] font-medium text-slate-400 mt-1">days ago</span>
               </div>
            </div>

            <div className="bg-slate-50 sm:bg-white/40 rounded-2xl p-4 border border-slate-100 sm:border-white/50 flex flex-col justify-between">
               <div className="flex items-center justify-center gap-1.5 text-slate-400 mb-2">
                 <RotateCwIcon size={14} />
                 <span className="text-[10px] uppercase tracking-wider font-semibold">Occurred</span>
               </div>
               <div className="text-lg font-bold text-slate-700 leading-none">
                 {occurrences}<span className="text-xs align-top">{getSuffix(occurrences)}</span>
                 <span className="block text-[10px] font-medium text-slate-400 mt-1">time</span>
               </div>
            </div>
          </div>

          <div className="mt-6 flex items-center justify-center gap-2 text-[10px] text-slate-400 font-medium uppercase tracking-widest">
             <ClockIcon size={12} />
             <span>
              {event.dynamicDate ? 'Approx. 3 Days' : `${String(event.hour).padStart(2,'0')}:${String(event.minute).padStart(2,'0')}`}
             </span>
          </div>
        </div>
      );
    });

    const wrap = (min, max, v) => {
      const rangeSize = max - min;
      return ((((v - min) % rangeSize) + rangeSize) % rangeSize) + min;
    };

    // --- NEW: VIRTUAL SLIDER CAROUSEL (AnimatePresence) ---
    // This architecture creates a FRESH component on every slide,
    // which fixes the "Blank/Stuck" card issue on mobile browsers.
    const variants = {
      enter: (direction) => ({
        x: direction > 0 ? 300 : -300,
        opacity: 0,
        scale: 0.8,
        zIndex: 0
      }),
      center: {
        zIndex: 1,
        x: 0,
        opacity: 1,
        scale: 1
      },
      exit: (direction) => ({
        zIndex: 0,
        x: direction < 0 ? 300 : -300,
        opacity: 0,
        scale: 0.8
      })
    };

    const MemoryCarousel = memo(({ allEvents, page, setPage }) => {
      // We track direction to know if we should slide left or right
      const prevPage = useRef(page);
      const direction = page > prevPage.current ? 1 : -1;
      
      // Update ref after render logic
      if (page !== prevPage.current) {
         prevPage.current = page;
      }

      const eventIndex = wrap(0, allEvents.length, page);
      const activeEvent = allEvents[eventIndex];
      
      const paginate = (newDirection) => {
        setPage(page + newDirection);
      };

      return (
        <div className="relative h-[500px] w-full flex items-center justify-center overflow-hidden" style={{ touchAction: 'pan-y' }}>
          <AnimatePresence initial={false} custom={direction} mode="popLayout">
            <motion.div
              key={page}
              custom={direction}
              variants={variants}
              initial="enter"
              animate="center"
              exit="exit"
              transition={{
                x: { type: "spring", stiffness: 300, damping: 30 },
                opacity: { duration: 0.2 }
              }}
              drag="x"
              dragConstraints={{ left: 0, right: 0 }}
              dragElastic={1}
              onDragEnd={(e, { offset, velocity }) => {
                const swipe = Math.abs(offset.x) * velocity.x;
                if (swipe < -10000 || offset.x < -100) {
                  paginate(1);
                } else if (swipe > 10000 || offset.x > 100) {
                  paginate(-1);
                }
              }}
              className="absolute w-full flex justify-center items-center cursor-grab active:cursor-grabbing"
              style={{ backfaceVisibility: 'hidden' }}
            >
              <TimelineCard event={activeEvent} isActive={true} />
            </motion.div>
          </AnimatePresence>
          
           <div className="absolute inset-x-4 top-1/2 -translate-y-1/2 flex justify-between pointer-events-none z-0 opacity-20 sm:hidden">
               <ChevronLeftIcon size={32} />
               <ChevronRightIcon size={32} />
           </div>
        </div>
      );
    });

    // --- MAIN CONTENT COMPONENT ---
    const MainContent = ({ allEvents, status, timeParts, occurrenceCount, page, setPage, now }) => {
      const displayEvent = status.activeEvent || allEvents[0];
      const displayDate = status.isLive 
           ? "Happening Now"
           : getNextOccurrence(displayEvent, now).toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

      // Calculate index purely for the dots indicator
      const eventIndex = wrap(0, allEvents.length, page);

      return (
          <motion.div 
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 1 }}
            className="relative min-h-screen text-slate-800 font-sans selection:bg-rose-200 overflow-x-hidden"
          >
            <main className="relative z-10 w-full flex flex-col min-h-screen pb-6">
              
              <header className="pt-8 px-6 flex justify-center items-center max-w-2xl mx-auto w-full text-center">
                 <div className="flex flex-col">
                   <span className="font-serif italic text-2xl text-rose-500">Waqas & Safiyya</span>
                   <span className="text-[10px] uppercase tracking-[0.2em] text-slate-500 mt-1">Forever since 2025</span>
                 </div>
              </header>

              <section className="mt-8 px-6 text-center max-w-2xl mx-auto w-full">
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.8 }}
                >
                  <div className={`
                    inline-flex items-center gap-2 px-3 py-1 rounded-full border mb-6 backdrop-blur-md shadow-sm transition-colors duration-300
                    ${status.isLive ? 'bg-red-50 border-red-200 text-red-600' : 'bg-white/40 border-white/50 text-slate-600'}
                  `}>
                    <span className="relative flex h-2 w-2">
                      {status.isLive ? (
                         <span className="relative inline-flex rounded-full h-2 w-2 bg-red-600"></span>
                      ) : (
                        <>
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-2 w-2 bg-rose-500"></span>
                        </>
                      )}
                    </span>
                    <span className="text-[11px] uppercase tracking-widest font-semibold">
                      {status.isLive ? 'Live Event' : 'Up Next'}
                    </span>
                  </div>

                  <AnimatePresence mode="wait">
                    <motion.div
                      key={displayEvent.id}
                      initial={{ opacity: 0, scale: 0.95 }}
                      animate={{ opacity: 1, scale: 1 }}
                      exit={{ opacity: 0, scale: 1.05 }}
                      transition={{ duration: 0.5 }}
                    >
                      <h1 className="text-4xl sm:text-5xl font-serif text-slate-900 leading-tight mb-2">
                        {displayEvent.title}
                      </h1>
                      <p className={`text-lg sm:text-xl font-light ${status.isLive ? 'text-red-500 font-medium' : 'text-slate-500'}`}>
                        {displayDate}
                      </p>
                    </motion.div>
                  </AnimatePresence>

                  <CountdownGrid parts={timeParts} isLive={status.isLive} />

                  <div className="mt-8 text-sm text-slate-500 bg-white/30 inline-block px-4 py-2 rounded-xl backdrop-blur-sm border border-white/40 shadow-sm">
                     This will be the <span className="font-bold text-rose-500">{occurrenceCount}{getSuffix(occurrenceCount)}</span> time since our journey began.
                  </div>
                </motion.div>
              </section>

              <div className="flex-grow"></div>

              <section className="mt-10 mb-8 w-full overflow-hidden">
                <div className="px-6 mb-6 flex items-end justify-between max-w-2xl mx-auto w-full">
                  <div>
                    <h2 className="text-2xl font-serif text-slate-800">Our Memories</h2>
                    <p className="text-xs uppercase tracking-widest text-slate-500 mt-1">Swipe for infinity</p>
                  </div>
                </div>

                {/* --- ISOLATED SWIPE CAROUSEL --- */}
                {/* This uses React.memo so it won't re-render with timer ticks */}
                <MemoryCarousel allEvents={allEvents} page={page} setPage={setPage} />
                
                <div className="flex justify-center gap-2 mt-2">
                  {allEvents.map((_, i) => (
                    <div 
                      key={i} 
                      className={`h-1.5 rounded-full transition-all duration-300 ${i === eventIndex ? 'w-6 bg-rose-400' : 'w-1.5 bg-gray-300'}`}
                    />
                  ))}
                </div>

              </section>

              <footer className="text-center pb-6 opacity-60">
                 <div className="inline-flex items-center gap-1.5 text-xs text-slate-500">
                   <span>Made with</span>
                   <HeartIcon className="w-3 h-3 text-rose-400 fill-rose-400" />
                   <span>for Safiyya</span>
                 </div>
              </footer>

            </main>
          </motion.div>
      );
    }

    const App = () => {
      const [now, setNow] = useState(new Date());
      const [allEvents, setAllEvents] = useState(STATIC_EVENTS);
      const [status, setStatus] = useState({ activeEvent: null, isLive: false, targetDate: null });
      const [timeParts, setTimeParts] = useState({ months: 0, days: 0, hours: 0, minutes: 0, seconds: 0 });
      const [page, setPage] = useState(0);
      const [isLoaded, setIsLoaded] = useState(false);
      const [isLocked, setIsLocked] = useState(true);

      useEffect(() => {
        const init = async () => {
          try {
            const islamicEvents = await fetchIslamicEvents();
            const currentNow = new Date();
            const combined = [...STATIC_EVENTS, ...islamicEvents];
            
            combined.sort((a, b) => {
              const dateA = getNextOccurrence(a, currentNow);
              const dateB = getNextOccurrence(b, currentNow);
              return dateA.getTime() - dateB.getTime();
            });
            
            setAllEvents(combined);

            const st = getStatus(combined, currentNow);
            setStatus(st);
            
            if(st.targetDate && !st.isLive) {
              setTimeParts(calculateTimeParts(st.targetDate, currentNow));
            } else {
              setTimeParts({ months: 0, days: 0, hours: 0, minutes: 0, seconds: 0 });
            }

            if (st.activeEvent) {
              const idx = combined.findIndex(e => e.id === st.activeEvent.id);
              if (idx !== -1) setPage(idx);
            }
          } catch(err) {
            console.error("Initialization error", err);
          } finally {
            setIsLoaded(true);
          }
        };
        init();
      }, []);

      useEffect(() => {
        if (!isLoaded) return;
        const timer = setInterval(() => {
          const currentNow = new Date();
          setNow(currentNow);
          
          const st = getStatus(allEvents, currentNow);
          setStatus(st);

          if (st.isLive) {
            setTimeParts({ months: 0, days: 0, hours: 0, minutes: 0, seconds: 0 });
          } else if (st.targetDate) {
            setTimeParts(calculateTimeParts(st.targetDate, currentNow));
          }
        }, 1000);
        return () => clearInterval(timer);
      }, [isLoaded, allEvents]);

      const occurrenceCount = status.activeEvent 
        ? countOccurrences(status.activeEvent, BASE_START_DATE, now) + (status.isLive ? 0 : 1)
        : 0;

      if (!isLoaded) {
         return (
           <div className="fixed inset-0 flex items-center justify-center bg-rose-50 text-rose-400">
             <motion.div 
               animate={{ scale: [1, 1.2, 1], opacity: [0.5, 1, 0.5] }} 
               transition={{ repeat: Infinity, duration: 2 }}
             >
               <HeartIcon className="w-12 h-12" />
             </motion.div>
           </div>
         )
      }

      return (
        <>
          <Background />
          <AnimatePresence>
            {isLocked ? (
              <LockScreen key="lock" onUnlock={() => setIsLocked(false)} />
            ) : (
              <MainContent 
                key="main"
                allEvents={allEvents}
                status={status}
                timeParts={timeParts}
                occurrenceCount={occurrenceCount}
                page={page}
                setPage={setPage}
                now={now}
              />
            )}
          </AnimatePresence>
        </>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
